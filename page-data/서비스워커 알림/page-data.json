{"componentChunkName":"component---src-templates-post-template-tsx","path":"/서비스워커 알림/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h3>Mobile Notification</h3>\n<p><a href=\"https://saramkim.github.io/time-log\" target=\"_blank\" rel=\"nofollow\">TimeLog</a>의 알람으로 사용할 notification을 만들며 얻은 것들을 공유합니다.<br></br></p>\n<p><code class=\"language-text\">new Notification()</code> Constructor로 생성한 알림은 모바일에서 작동하지 않습니다.</p>\n<p>Service worker의 <code class=\"language-text\">showNotification()</code> Method를 사용하면 모바일에서도 작동하고, 알림에 버튼(actions)을 추가할 수도 있습니다.</p>\n<p><a href=\"https://saramkim.github.io/%EC%9B%B9%EC%9B%8C%EC%BB%A4%20%ED%83%80%EC%9D%B4%EB%A8%B8(Web%20Worker%20Timer)/\" target=\"_blank\" rel=\"nofollow\">이전 글</a>에서 다룬 타이머를 countdown 타이머로 만들고, notification을 더하여 알람 타이머를 만들었습니다.</p>\n<h3>Service Worker</h3>\n<ul>\n<li>Web worker와 마찬가지로 Main thread와 별개로 Background thread에서 script를 실행합니다.</li>\n<li>보안상의 이유로 HTTPS 프로토콜과 localhost에서만 작동합니다.</li>\n<li>Script 파일(service-worker.js)을 public 폴더에 저장해야 정상 작동합니다.<br></br></li>\n</ul>\n<p>Service worker의 Life cycle 특성상 업데이트를 반영하려면 새로고침이 필요합니다. (참고 링크 참조)</p>\n<p>하지만 저는 처음 접속할 때도 새로고침을 하지 않으면 Service worker가 동작하지 않는 현상이 있습니다.</p>\n<p>아직 그 원인을 찾지 못해 임시 해결책으로 사이트 접속 시 한 번 새로고침 되도록 하였습니다.</p>\n<hr>\n<blockquote>\n<h5>React</h5>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// service-worker.js</span>\r\n\r\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'notificationclick'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token comment\">//서비스워커 종료 방지</span>\r\n    clients<span class=\"token punctuation\">.</span><span class=\"token function\">matchAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'window'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">includeUncontrolled</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">clientList</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      clientList<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 해당 페이지 포커스</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// React</span>\r\n\r\n<span class=\"token operator\">...</span>\r\n\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">notificationRequest</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\r\n  Notification<span class=\"token punctuation\">.</span><span class=\"token function\">requestPermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">permission</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>permission <span class=\"token operator\">===</span> <span class=\"token string\">\"denied\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      window<span class=\"token punctuation\">.</span><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please allow notifications access to continue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> notificationOption <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Body\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token literal-property property\">icon</span><span class=\"token operator\">:</span> <span class=\"token string\">\"icon.jpg\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token literal-property property\">actions</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Check\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">action</span><span class=\"token operator\">:</span> <span class=\"token string\">\"check\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> <span class=\"token string\">\"notification-tag\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token literal-property property\">requireInteraction</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token literal-property property\">renotify</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 알림 중첩 시 미작동 방지</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">notificationRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">// 서비스워커 등록</span>\r\n  navigator<span class=\"token punctuation\">.</span>serviceWorker<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PUBLIC_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/service-worker.js</span><span class=\"token template-punctuation string\">`</span></span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>time <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 서비스워커가 활성화 되었다면 알림 실행</span>\r\n    navigator<span class=\"token punctuation\">.</span>serviceWorker<span class=\"token punctuation\">.</span>ready<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">registration</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      registration<span class=\"token punctuation\">.</span><span class=\"token function\">showNotification</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Title\"</span><span class=\"token punctuation\">,</span> notificationOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>time<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token operator\">...</span>\r\n</code></pre></div>\n<blockquote>\n<h6>새로고침 추가</h6>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> navigationTiming <span class=\"token operator\">=</span> performance<span class=\"token punctuation\">.</span><span class=\"token function\">getEntriesByType</span><span class=\"token punctuation\">(</span><span class=\"token string\">'navigation'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token comment\">// 새로고침 무한 루프 방지</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>navigationTiming<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'navigate'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">reload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h3>참고 링크</h3>\n<ul>\n<li>\n<p><a href=\"https://developer.mozilla.org/ko/docs/Web/API/Service_Worker_API\" target=\"_blank\" rel=\"nofollow\">Service Worker API</a></p>\n</li>\n<li>\n<p><a href=\"https://velog.io/@hancihu/%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%9B%8C%EC%BB%A4%EC%9D%98-%EC%83%9D%EB%AA%85-%EC%A3%BC%EA%B8%B0%EC%99%80-%EC%BA%90%EC%8B%9C-%EA%B4%80%EB%A6%AC\" target=\"_blank\" rel=\"nofollow\">[PWA] 서비스 워커의 생명 주기와 캐시 관리</a></p>\n</li>\n<li>\n<p><a href=\"https://sub0709.tistory.com/138\" target=\"_blank\" rel=\"nofollow\">브라우저 알림(Notification) 팝업에 버튼 추가 with ServiceWorker</a></p>\n</li>\n<li>\n<p><a href=\"https://redfin.engineering/how-to-fix-the-refresh-button-when-using-service-workers-a8e27af6df68\" target=\"_blank\" rel=\"nofollow\">How to Fix the Refresh Button When Using Service Workers</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/Performance/Navigation_and_resource_timings\" target=\"_blank\" rel=\"nofollow\">Navigation and resource timings</a></p>\n</li>\n</ul>","frontmatter":{"title":"서비스워커 알림(Service Worker Notification)","summary":"Service worker를 이용한 알림 & 한 번 새로고침","date":"2022.08.29.","categories":["React"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABfklEQVQoz42PO2/UQBRG55ewgR173uPH2F6vPTP2GikgCFLwKzaiACmCJpAuTeqInp6fRZeWAkSDItHQoFmiDRAhIR2Nvjv3O8UFhFBBOaEME+ph8h+4mr8tg1VlHnX7WdNsnjxWeb63hBBhiPDSR//yIcIyjDDjIML8AAUPPfkAckGFjBUiDBFGubwR0J8+un7Bi4X4ev/488nFx6htfNHO89E49eM0zc+gj13vFhBhbwt46cXf33348enL5fOzyuciTbNVXmgTJ0mWr5NspW3l4xthB3TyQlwdvP12/v4yn2uPqbLUxq5LvS7KQhuVZpiy36+9lrcZKIjHO7S/J54uKIU+lZIJyWXAZEC4wIzfhd6OvSXc5aWPAAnCrNkklU3rWle1tlbbqrS2MNaNVW3cp8O4vDG2Nra2dSNDBZI0m6a574dhGLt+6IbxF4ddd/zq9cmb08O263u3avuhc2Fsu2E4mvJCA0RZECsZxX8TxkGkwjiRYXybIFKY8p8qZ4JRk2iLPwAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/3d3a93984199ff2ec3ac239714544729/7f1d9/notification.png","srcSet":"/static/3d3a93984199ff2ec3ac239714544729/2d468/notification.png 90w,\n/static/3d3a93984199ff2ec3ac239714544729/ed019/notification.png 181w,\n/static/3d3a93984199ff2ec3ac239714544729/7f1d9/notification.png 361w","sizes":"(min-width: 361px) 361px, 100vw"},"sources":[{"srcSet":"/static/3d3a93984199ff2ec3ac239714544729/4830c/notification.webp 90w,\n/static/3d3a93984199ff2ec3ac239714544729/bcb5b/notification.webp 181w,\n/static/3d3a93984199ff2ec3ac239714544729/a4554/notification.webp 361w","type":"image/webp","sizes":"(min-width: 361px) 361px, 100vw"}]},"width":361,"height":176.99999999999997}},"publicURL":"/static/3d3a93984199ff2ec3ac239714544729/notification.png"}}}}]}},"pageContext":{"slug":"/서비스워커 알림/","next":{"fields":{"slug":"/요즘 생각/"},"frontmatter":{"title":"요즘 생각"}},"prev":{"fields":{"slug":"/웹워커 타이머/"},"frontmatter":{"title":"웹워커 타이머(Web Worker Timer)"}}}},"staticQueryHashes":[]}