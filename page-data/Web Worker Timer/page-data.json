{"componentChunkName":"component---src-templates-post-template-tsx","path":"/Web Worker Timer/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h3>Timer 제작 과정</h3>\n<blockquote>\n<h6>setInterval → useInterval → Web Worker</h6>\n</blockquote>\n<p><a href=\"https://saramkim.github.io/time-log\" target=\"_blank\" rel=\"nofollow\">TimeLog</a>에 사용할 타이머를 만드는 과정에서 겪은 경험을 공유하고자 합니다.<br></br></p>\n<p>처음은 누구라도 그러하듯이 <strong>setInterval</strong>로 타이머를 만들기 시작했습니다.</p>\n<p>하지만 타이머가 제대로 작동하지 않아 검색을 해보니, setInterval에 몇 가지 문제가 있는데,</p>\n<p>그 해결책으로 <strong>useInterval</strong>이라는 custom Hook을 발견했습니다. (문제에 관한 내용은 아래 참고 링크에 있습니다)</p>\n<p>따라서 useInterval로 바꾸었고, 타이머가 작동하여 뿌듯한 기분으로 다른 작업을 하였습니다.<br></br></p>\n<p>하지만 저의 뿌듯함을 비웃듯 타이머에 또 다른 문제가 생겼습니다.</p>\n<p>타이머를 오래 작동하면 타이머에 지연이 생기는 것이었습니다.</p>\n<p>이번에도 검색을 통해 문제의 원인을 찾아보았습니다.<br></br></p>\n<ul>\n<li>CPU가 과부하 상태인 경우</li>\n<li>브라우저 탭이 백그라운드 모드인 경우</li>\n<li>노트북이 배터리에 의존해서 구동 중인 경우<br></br></li>\n</ul>\n<p>위의 경우 브라우저 내 타이머가 느려져 setInterval의 지연 간격이 길어진다는 것이었습니다. (useInterval도 setInterval을 사용합니다)</p>\n<details>\r\n<summary>경우 추측</summary>\n<p>크롬은 메모리가 부족하면 비활성 탭이 절전 되는 기능인, “Automatic tab discarding”이 내장되어 있습니다.</p>\n<p>“chrome://flags”에서 Automatic tab discarding을 조절할 수 있었지만 없어졌고,</p>\n<p>“chrome://discards”에 접속하면 모든 탭에 Auto Discardable이 활성화 되어 있는 것을 확인할 수 있습니다.</p>\n<p>(참고로 Graph탭에서 Web Workers를 확인할 수도 있습니다)</p>\n<p>이 기능으로 인해 탭이 절전 됐거나, 다른 내장 기능에 의해 자동으로 백그라운드 모드에 진입해서 지연된 것 같습니다.</p>\n</details><br>\n<p>이를 해결하기 위한 무수한 검색 중에 Web Worker를 발견합니다.<br></br></p>\n<p><strong>Web Worker</strong>는 웹의 Main thread에서 실행되는 script와 별개로, Background thread에서 실행되는 script입니다.</p>\n<p>따라서 Web Worker에서 setInterval을 사용하면 브라우저 내 타이머 지연과 상관없이 정상 작동합니다.</p>\n<p>그러니 어서 사용합시다. (React &#x26; TypeScript 기준)</p>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// tsconfig.json</span>\r\n<span class=\"token punctuation\">{</span>\r\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    ...\r\n    <span class=\"token property\">\"lib\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> ... <span class=\"token string\">\"WebWorker\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Worker Scope에서 쓰이는 타입 추가</span>\r\n    ...\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.ts</span>\r\n<span class=\"token keyword\">const</span> self <span class=\"token operator\">=</span> globalThis <span class=\"token keyword\">as</span> unknown <span class=\"token keyword\">as</span> DedicatedWorkerGlobalScope<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Double assertion</span>\r\n<span class=\"token keyword\">let</span> time <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\nself<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    time<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n    self<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// --isolatedModules 에러 피하기 (모듈화)</span>\r\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Timer.tsx</span>\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">Timer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>time<span class=\"token punctuation\">,</span> setTime<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>timerOn<span class=\"token punctuation\">,</span> setTimerOn<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">const</span> timeSecond <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>time <span class=\"token operator\">/</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">timerStart</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimerOn</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">timerStop</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimerOn</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./worker'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// webpack5 이후 용법</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timerOn <span class=\"token operator\">===</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      worker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timer start'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      worker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">e</span><span class=\"token operator\">:</span> MessageEvent<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">setTime</span><span class=\"token punctuation\">(</span>time <span class=\"token operator\">+</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      worker<span class=\"token punctuation\">.</span><span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>timerOn<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\r\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">'App'</span><span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">'timer'</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>timeSecond<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\r\n        <span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>timerStart<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>Start<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\r\n        <span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>timerStop<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>Stop<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Timer<span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h3>동작 과정</h3>\n<ol>\n<li>\n<p>Background thread에서 실행할 Worker sciprt를 worker.ts에 작성합니다. (이하 worker)<br></br></p>\n</li>\n<li>\n<p>Timer.tsx(main script)에서 <code class=\"language-text\">new Worker()</code>로 worker를 실행합니다.</p>\n<ul>\n<li>timerOn 값이 바뀔 때마다 그 전에 <code class=\"language-text\">worker.terminate()</code>로 현재 worker가 종료되고, 이후 새로운 worker를 실행합니다.<br></br></li>\n</ul>\n</li>\n<li>\n<p>타이머 버튼의 클릭 이벤트로 timerOn 값이 true가 되면, <code class=\"language-text\">worker.postMessage()</code>로 worker에 메세지 데이터를 전달합니다.</p>\n<ul>\n<li>여기서 메세지 데이터는 사용하지 않으므로 중요하지 않습니다.<br></br></li>\n</ul>\n</li>\n<li>\n<p>worker의 <code class=\"language-text\">self.onmessage</code>에 적힌 동작들이 실행됩니다. (setInterval 실행)<br></br></p>\n</li>\n<li>\n<p>Timer.tsx에서 <code class=\"language-text\">worker.onmessage</code>로, worker에서 <code class=\"language-text\">self.postMessage()</code>로 보낸 time을 100ms마다 기존 time에 추가합니다.<br></br></p>\n</li>\n</ol>\n<hr>\n<h3>참고 링크</h3>\n<ul>\n<li>\n<p><a href=\"https://www.youtube.com/watch?v=2tUdyY5uBSw\" target=\"_blank\" rel=\"nofollow\">코좀봐코 - React에서의 타이머 part 1 : setInterval 말고 이것!</a></p>\n</li>\n<li>\n<p><a href=\"https://overreacted.io/making-setinterval-declarative-with-react-hooks/\" target=\"_blank\" rel=\"nofollow\">Making setInterval Declarative with React Hooks</a></p>\n</li>\n<li>\n<p><a href=\"https://ko.javascript.info/settimeout-setinterval\" target=\"_blank\" rel=\"nofollow\">setTimeout과 setInterval을 이용한 호출 스케줄링</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API\" target=\"_blank\" rel=\"nofollow\">Web Workers API</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers\" target=\"_blank\" rel=\"nofollow\">Using Web Workers</a></p>\n</li>\n<li>\n<p><a href=\"https://pks2974.medium.com/web-worker-%EA%B0%84%EB%8B%A8-%EC%A0%95%EB%A6%AC%ED%95%98%EA%B8%B0-4ec90055aa4d\" target=\"_blank\" rel=\"nofollow\">Web Worker 간단 정리하기</a></p>\n</li>\n<li>\n<p><a href=\"https://webpack.kr/guides/web-workers/\" target=\"_blank\" rel=\"nofollow\">Webpack - Web Workers</a></p>\n</li>\n<li>\n<p><a href=\"https://stackoverflow.com/questions/60695105/how-to-use-webworkers-in-react-using-typescript\" target=\"_blank\" rel=\"nofollow\">How to use WebWorkers in React using Typescript</a></p>\n</li>\n<li>\n<p><a href=\"https://radlohead.gitbook.io/typescript-deep-dive/type-system/type-assertion\" target=\"_blank\" rel=\"nofollow\">타입 표명(Type Assertion)</a></p>\n</li>\n</ul>","frontmatter":{"title":"Web Worker Timer","summary":"Web worker를 이용한 타이머 만들기","date":"2022.08.22.","categories":["React","TS"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAYFCAn/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHVWFt0CUPIf//EABwQAAICAgMAAAAAAAAAAAAAAAQFAQYAAgMxQf/aAAgBAQABBQJ5ZH4jo222zTjrZhR6mc9jr//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EACMQAAICAgEEAgMAAAAAAAAAAAMEAQIFExQAERUhBhIkcpH/2gAIAQEABj8CdTFeFkaHCEzHjLs+Jxcjw94zsk90b5LLmRS0T3GHibfp+G5sUuJIdG7YtYtscPHuH2NFVfJlrkuStLgL8fkCJSI0teDcyFt5imBIhMN323lh8QmtHG5yi77K6T/H9auaoMLHasQO2zYKtRXpWLfr1/eo6//EAB0QAQACAgIDAAAAAAAAAAAAAAEAESFBcaExUZH/2gAIAQEAAT8hTc+Mc3QGT94MqMuYSiX9deaF5gGBjQBCiso28vATm3PMt211qvk6xP/aAAwDAQACAAMAAAAQAM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEBAAMAAwAAAAAAAAAAAAABEQAhMUFRcf/aAAgBAQABPxCBhpAtiQ42+aINv3j045lj0GEbCLAIqn+VQSCNAUioJxQqb0YwFTnWacvpnqs7jVVVWV2qhVeq+Vz/2Q=="},"images":{"fallback":{"src":"/static/f48564d78ba6453ae84a0297905a86d7/dc991/20220821_230348.jpg","srcSet":"/static/f48564d78ba6453ae84a0297905a86d7/090e1/20220821_230348.jpg 150w,\n/static/f48564d78ba6453ae84a0297905a86d7/c8d94/20220821_230348.jpg 300w,\n/static/f48564d78ba6453ae84a0297905a86d7/dc991/20220821_230348.jpg 600w","sizes":"(min-width: 600px) 600px, 100vw"},"sources":[{"srcSet":"/static/f48564d78ba6453ae84a0297905a86d7/c2036/20220821_230348.webp 150w,\n/static/f48564d78ba6453ae84a0297905a86d7/77dc5/20220821_230348.webp 300w,\n/static/f48564d78ba6453ae84a0297905a86d7/2cb69/20220821_230348.webp 600w","type":"image/webp","sizes":"(min-width: 600px) 600px, 100vw"}]},"width":600,"height":300}},"publicURL":"/static/f48564d78ba6453ae84a0297905a86d7/20220821_230348.jpg"}}}}]}},"pageContext":{"slug":"/Web Worker Timer/","next":null,"prev":{"fields":{"slug":"/커스텀 셀렉트 박스/"},"frontmatter":{"title":"커스텀 셀렉트 박스(Custom Select Box)"}}}},"staticQueryHashes":[]}